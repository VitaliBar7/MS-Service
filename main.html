<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Issue Tracker</title>
  <style>
    /* --- ×¢×™×¦×•×‘ ×›×œ×œ×™ --- */
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .container {
      max-width: 500px;
      margin: 50px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    input{
      width: 95%;
      padding: 12px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    select, button, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background-color: #0056b3;
      transform: scale(1.05);
    }
    .loading {
      text-align: center;
      margin-top: 20px;
      font-size: 16px;
      color: #666;
      display: none;
    }
    
    /* --- ×›×¨×˜×™×¡×™ ×˜×™×§×˜ --- */
    .issue-card {
      background: #fff;
      padding: 15px;
      margin-top: 10px;
      border-radius: 8px;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: 0.3s ease-in-out;
    }
    .issue-card:hover {
      transform: scale(1.02);
    }
    .status {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
      min-width: 90px;
      text-align: center;
    }
    .pending { background-color: #ffcc00; color: #333; }
    .resolved { background-color: #28a745; color: white; }
    .in-progress {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #007bff;
      color: white;
      padding: 5px;
      border-radius: 50px;
    }
    .loader {
      width: 16px;
      height: 16px;
      border: 3px solid white;
      border-top: 3px solid transparent;
      border-radius: 50%;
      margin-left: 8px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* --- Sidebar ×œ×¢×¨×™×›×ª ×˜×™×§×˜ (×™×× ×™) --- */
    .sidebar {
      position: fixed;
      top: 0;
      right: -350px;
      width: 300px;
      height: 100%;
      background: white;
      box-shadow: -4px 0px 10px rgba(0,0,0,0.2);
      padding: 20px;
      transition: right 0.4s ease-in-out;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .sidebar.show {
      right: 0;
    }
    .close-btn {
      background: #dc3545;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      align-self: flex-end;
    }
    .save-btn {
      background: #28a745;
      margin-top: 10px;
    }
    .delete-btn {
      background: #c82333;
      margin-top: 5px;
    }
    
    /* --- Ticket Notes ×‘×ª×•×š Sidebar (×™×× ×™) --- */
    .ticket-notes {
      margin-top: 20px;
      text-align: left;
    }
    .ticket-notes h3 {
      margin-bottom: 10px;
      font-size: 18px;
    }
    .ticket-notes textarea {
      resize: vertical;
      height: 60px;
    }
    .ticket-note-btn {
      background-color: #007bff;
      margin-top: 5px;
    }
    .ticket-note {
      background: #f9f9f9;
      padding: 8px;
      margin-top: 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    .ticket-note button {
      margin-left: 5px;
      padding: 4px 8px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .ticket-note .edit-btn {
      background-color: #28a745;
      color: white;
    }
    .ticket-note .delete-btn {
      background-color: #dc3545;
      color: white;
    }
    
    /* --- Sidebar ×œ×”×¢×¨×•×ª ×›×œ×œ×™×•×ª (×©×××œ×™) --- */
    .notes-sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 250px;
      height: 100%;
      background: #fff;
      box-shadow: 4px 0px 10px rgba(0,0,0,0.2);
      padding: 20px;
      transition: left 0.4s ease-in-out;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .notes-sidebar.show {
      left: 0;
    }
    .notes-sidebar h2 {
      margin-top: 0;
      font-size: 20px;
    }
    .note-input {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .note-btn {
      background-color: #007bff;
      color: white;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    .note {
      background: #f9f9f9;
      padding: 8px;
      margin-top: 10px;
      border-radius: 4px;
      text-align: left;
      font-size: 14px;
    }
    .note button {
      margin-left: 5px;
      padding: 4px 8px;
      font-size: 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .note .edit-btn {
      background-color: #28a745;
      color: white;
    }
    .note .delete-btn {
      background-color: #dc3545;
      color: white;
    }
  </style>
</head>
<body>

<!-- Main Issue Tracker Container -->
<div class="container">
  <h1>ğŸ”§ Issue Tracker</h1>
  <input type="text" id="description" placeholder="Issue description">
  <select id="status">
    <option value="pending">ğŸŸ¡ Pending</option>
    <option value="in progress">ğŸ”„ In Progress</option>
    <option value="closed">âœ… Resolved</option>
  </select>
  <button onclick="addIssue()">â• Add Issue</button>
  <!-- ×›×¤×ª×•×¨ ×œ×¤×ª×™×—×ª ×—×œ×•× ×™×ª ×”×¢×¨×•×ª ×›×œ×œ×™×•×ª -->
  <button onclick="toggleNotes()">ğŸ“ Open Notes</button>
  <div class="loading" id="loading">â³ Loading issues...</div>
  <div id="issue-list"></div>
</div>

<!-- Sidebar for editing an issue (right side) -->
<div class="sidebar" id="sidebar">
  <button class="close-btn" onclick="closeSidebar()">âœ– Close</button>
  <h2>Edit Issue</h2>
  <input type="text" id="edit-description">
  <select id="edit-status">
    <option value="pending">ğŸŸ¡ Pending</option>
    <option value="in progress">ğŸ”„ In Progress</option>
    <option value="closed">âœ… Resolved</option>
  </select>
  <button class="save-btn" onclick="saveChanges()">ğŸ’¾ Save Changes</button>
  <button class="delete-btn" onclick="deleteIssue()">âŒ Delete Issue</button>
  
  <!-- Ticket-specific Notes Section -->
  <div class="ticket-notes">
    <h3>Ticket Notes</h3>
    <textarea id="ticket-note-input" placeholder="Add a note for this ticket"></textarea>
    <button class="ticket-note-btn" onclick="addTicketNote()">Add Ticket Note</button>
    <div id="ticket-notes-list"></div>
  </div>
</div>

<!-- Sidebar for general notes (left side) -->
<div class="notes-sidebar" id="notes-sidebar">
  <button class="close-btn" onclick="toggleNotes()">âœ– Close Notes</button>
  <h2>General Notes</h2>
  <textarea id="note-content" class="note-input" placeholder="Write a note..."></textarea>
  <button class="note-btn" onclick="addNote()">Add Note</button>
  <div id="notes-list"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBNAeLlnS2RoUHcmIALf4B5GviuZ-moOl0",
    authDomain: "msdata-service.firebaseapp.com",
    projectId: "msdata-service",
    storageBucket: "msdata-service.appspot.com",
    messagingSenderId: "721052867041",
    appId: "1:721052867041:web:bb9a81b7ace02204945aa0",
    measurementId: "G-5M7ZFHXT0M"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const issuesCollection = collection(db, "issues");
  const notesCollection = collection(db, "notes");
  let selectedIssueId = null;

  // ×¤×•× ×§×¦×™×•×ª ×œ×˜×™×¤×•×œ ×‘×˜×™×§×˜×™×
  async function addIssue() {
    const description = document.getElementById("description").value.trim();
    if (!description) {
      alert("âš  Please enter an issue description.");
      return;
    }
    const status = document.getElementById("status").value;
    const date = new Date().toLocaleString();
    let completionTime = "";
    if (status === "closed") {
      completionTime = new Date().toLocaleString();
    }
    await addDoc(issuesCollection, { description, status, date, completionTime });
    document.getElementById("description").value = "";
    loadIssues();
  }

  async function loadIssues() {
    const issueList = document.getElementById("issue-list");
    issueList.innerHTML = "";
    document.getElementById("loading").style.display = "block";

    const querySnapshot = await getDocs(issuesCollection);
    querySnapshot.forEach((issueDoc) => {
      const issue = issueDoc.data();
      const card = document.createElement("div");
      card.classList.add("issue-card");

      let statusHTML = "";
      if (issue.status === "in progress") {
        statusHTML = `<div class="status in-progress">ğŸ”„ In Progress <div class="loader"></div></div>`;
      } else if (issue.status === "pending") {
        statusHTML = `<div class="status pending">ğŸŸ¡ Pending</div>`;
      } else if (issue.status === "closed") {
        statusHTML = `<div class="status resolved">âœ… Resolved<br><small>${issue.completionTime || ""}</small></div>`;
      }

      card.innerHTML = `<div>
                          <h3>${issue.description}</h3>
                          <p>ğŸ“… ${issue.date}</p>
                        </div>
                        ${statusHTML}`;

      card.onclick = () => openSidebar(issueDoc.id, issue);
      issueList.appendChild(card);
    });

    document.getElementById("loading").style.display = "none";
  }

  function openSidebar(id, issue) {
    document.getElementById("sidebar").classList.add("show");
    document.getElementById("edit-description").value = issue.description;
    document.getElementById("edit-status").value = issue.status;
    selectedIssueId = id;
    // ×˜×¢×Ÿ ×”×¢×¨×•×ª ×œ×˜×™×§×˜ ×”× ×‘×—×¨
    loadTicketNotes();
  }

  function closeSidebar() {
    document.getElementById("sidebar").classList.remove("show");
  }

  async function saveChanges() {
    if (!selectedIssueId) return;
    const newDesc = document.getElementById("edit-description").value;
    const newStatus = document.getElementById("edit-status").value;
    const updates = { description: newDesc, status: newStatus };
    if (newStatus === "closed") {
      updates.completionTime = new Date().toLocaleString();
    }
    await updateDoc(doc(db, "issues", selectedIssueId), updates);
    closeSidebar();
    loadIssues();
  }

  async function deleteIssue() {
    if (!selectedIssueId) return;
    await deleteDoc(doc(db, "issues", selectedIssueId));
    closeSidebar();
    loadIssues();
  }

  // ×¤×•× ×§×¦×™×•×ª ×œ×˜×™×¤×•×œ ×‘×”×¢×¨×•×ª ×›×œ×œ×™×•×ª (Notes Sidebar)
  async function addNote() {
    const noteContent = document.getElementById("note-content").value.trim();
    if (!noteContent) {
      alert("âš  Please enter a note.");
      return;
    }
    const date = new Date().toLocaleString();
    await addDoc(notesCollection, { note: noteContent, date });
    document.getElementById("note-content").value = "";
    loadNotes();
  }

  async function loadNotes() {
    const notesList = document.getElementById("notes-list");
    notesList.innerHTML = "";
    const querySnapshot = await getDocs(notesCollection);
    querySnapshot.forEach((noteDoc) => {
      const noteData = noteDoc.data();
      const noteDiv = document.createElement("div");
      noteDiv.classList.add("note");
      noteDiv.innerHTML = `<strong>${noteData.date}:</strong> <span class="note-text">${noteData.note}</span>
                           <button class="edit-btn" onclick='editNote("${noteDoc.id}", ${JSON.stringify(noteData.note)})'>Edit</button>
                           <button class="delete-btn" onclick="deleteNote('${noteDoc.id}')">Delete</button>`;
      notesList.appendChild(noteDiv);
    });
  }

  async function editNote(noteId, currentText) {
    const newText = prompt("Edit note:", currentText);
    if (newText !== null && newText.trim() !== "" && newText.trim() !== currentText.trim()) {
      await updateDoc(doc(db, "notes", noteId), { note: newText });
      loadNotes();
    }
  }

  async function deleteNote(noteId) {
    await deleteDoc(doc(db, "notes", noteId));
    loadNotes();
  }

  // ×¤×•× ×§×¦×™×•×ª ×œ×˜×™×¤×•×œ ×‘×”×¢×¨×•×ª ×œ×˜×™×§×˜ (Ticket Notes)
  async function addTicketNote() {
    const noteContent = document.getElementById("ticket-note-input").value.trim();
    if (!noteContent) {
      alert("âš  Please enter a note for this ticket.");
      return;
    }
    const date = new Date().toLocaleString();
    const ticketNotesCollection = collection(db, "issues", selectedIssueId, "ticketNotes");
    await addDoc(ticketNotesCollection, { note: noteContent, date });
    document.getElementById("ticket-note-input").value = "";
    loadTicketNotes();
  }

  async function loadTicketNotes() {
    const notesList = document.getElementById("ticket-notes-list");
    notesList.innerHTML = "";
    const ticketNotesCollection = collection(db, "issues", selectedIssueId, "ticketNotes");
    const querySnapshot = await getDocs(ticketNotesCollection);
    querySnapshot.forEach((noteDoc) => {
      const noteData = noteDoc.data();
      const noteDiv = document.createElement("div");
      noteDiv.classList.add("ticket-note");
      noteDiv.innerHTML = `<strong>${noteData.date}:</strong> <span class="note-text">${noteData.note}</span>
                           <button class="edit-btn" onclick='editTicketNote("${noteDoc.id}", ${JSON.stringify(noteData.note)})'>Edit</button>
                           <button class="delete-btn" onclick="deleteTicketNote('${noteDoc.id}')">Delete</button>`;
      notesList.appendChild(noteDiv);
    });
  }

  async function editTicketNote(noteId, currentText) {
    const newText = prompt("Edit ticket note:", currentText);
    if (newText !== null && newText.trim() !== "" && newText.trim() !== currentText.trim()) {
      await updateDoc(doc(db, "issues", selectedIssueId, "ticketNotes", noteId), { note: newText });
      loadTicketNotes();
    }
  }

  async function deleteTicketNote(noteId) {
    await deleteDoc(doc(db, "issues", selectedIssueId, "ticketNotes", noteId));
    loadTicketNotes();
  }

  // Toggle function for general notes sidebar (left side)
  function toggleNotes() {
    const notesSidebar = document.getElementById("notes-sidebar");
    if (notesSidebar.classList.contains("show")) {
      notesSidebar.classList.remove("show");
    } else {
      notesSidebar.classList.add("show");
    }
  }

  // ×˜×¢×™× ×” ×‘×¢×ª ×˜×¢×™× ×ª ×”×¢××•×“
  document.addEventListener("DOMContentLoaded", () => {
    loadIssues();
    loadNotes();
  });

  // ×—×©×™×¤×ª ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª
  window.addIssue = addIssue;
  window.loadIssues = loadIssues;
  window.openSidebar = openSidebar;
  window.closeSidebar = closeSidebar;
  window.saveChanges = saveChanges;
  window.deleteIssue = deleteIssue;
  window.addNote = addNote;
  window.loadNotes = loadNotes;
  window.toggleNotes = toggleNotes;
  window.editNote = editNote;
  window.deleteNote = deleteNote;
  window.addTicketNote = addTicketNote;
  window.loadTicketNotes = loadTicketNotes;
  window.editTicketNote = editTicketNote;
  window.deleteTicketNote = deleteTicketNote;
</script>

</body>
</html>
